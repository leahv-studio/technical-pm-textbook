#!/bin/bash
# bk-microsim-quality-report-generator - Generate quality reports for MicroSims
#
# Generates a comprehensive quality report for all MicroSims in the repository

set -e  # Exit on error

# Colors for output
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

# Script directory
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
REPO_ROOT="$(dirname "$SCRIPT_DIR")"
PYTHON_SCRIPT="$REPO_ROOT/src/book-metrics/microsim-quality-report.py"
OUTPUT_FILE="$REPO_ROOT/docs/learning-graph/microsim-quality-report.md"

# Function to print colored output
print_status() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

print_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

print_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

# Header
echo ""
echo "======================================"
echo "  MicroSim Quality Report Generator"
echo "======================================"
echo ""

# Check if Python script exists
if [ ! -f "$PYTHON_SCRIPT" ]; then
    print_error "Python script not found: $PYTHON_SCRIPT"
    exit 1
fi

print_status "Python script: $PYTHON_SCRIPT"
print_status "Output file: $OUTPUT_FILE"
echo ""

# Check for Python 3
if ! command -v python3 &> /dev/null; then
    print_error "Python 3 is required but not found"
    print_status "Please install Python 3: https://www.python.org/downloads/"
    exit 1
fi

PYTHON_VERSION=$(python3 --version)
print_status "Using $PYTHON_VERSION"
echo ""

# Run the Python script
print_status "Scanning MicroSims and generating report..."
echo ""

if python3 "$PYTHON_SCRIPT"; then
    echo ""
    print_success "Report generated successfully!"
    echo ""

    # Check if output file was created
    if [ -f "$OUTPUT_FILE" ]; then
        FILE_SIZE=$(ls -lh "$OUTPUT_FILE" | awk '{print $5}')
        print_status "Report file size: $FILE_SIZE"

        # Extract key metrics from the report
        if command -v grep &> /dev/null; then
            echo ""
            echo "Quick Stats:"
            echo "------------"

            TOTAL=$(grep "Total MicroSims" "$OUTPUT_FILE" | grep -oE '[0-9]+' | head -1)
            AVG_SCORE=$(grep "Average Quality Score" "$OUTPUT_FILE" | grep -oE '[0-9]+\.[0-9]+' | head -1)
            PERFECT=$(grep "Perfect (100)" "$OUTPUT_FILE" | grep -oE '\| [0-9]+' | head -1 | grep -oE '[0-9]+')

            if [ -n "$TOTAL" ]; then
                echo "  Total MicroSims: $TOTAL"
            fi
            if [ -n "$AVG_SCORE" ]; then
                echo "  Average Score: $AVG_SCORE/100"
            fi
            if [ -n "$PERFECT" ]; then
                echo "  Perfect Scores: $PERFECT"
            fi
        fi

        echo ""
        echo "View the report:"
        echo "  • File: $OUTPUT_FILE"
        echo "  • URL: file://$OUTPUT_FILE"
        echo ""

        # Suggest opening the file
        if [[ "$OSTYPE" == "darwin"* ]]; then
            # macOS
            print_status "Opening report in default markdown viewer..."
            open "$OUTPUT_FILE" 2>/dev/null || print_warning "Could not auto-open file"
        elif [[ "$OSTYPE" == "linux-gnu"* ]]; then
            # Linux
            if command -v xdg-open &> /dev/null; then
                print_status "Opening report in default viewer..."
                xdg-open "$OUTPUT_FILE" 2>/dev/null || print_warning "Could not auto-open file"
            fi
        fi

    else
        print_warning "Report file not found at expected location"
    fi

else
    print_error "Failed to generate report"
    exit 1
fi

echo ""
echo "======================================"
echo ""
